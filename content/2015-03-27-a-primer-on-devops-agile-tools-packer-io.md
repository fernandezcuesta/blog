Title: A primer on DevOps agile tools - packer.io
Date: 2015-03-29
tags: linux, internet, agile, linux
status: published

###Pros:
- Almost everything: automatization, high paralelysm, lot of customizable
elements, ...
- Debug capabilities: defining an environmental variable `PACKER_LOG`
with any value will redirect detailed log information to stderr.

###Cons (if any):
- Some elements are't too flexible. For example, with file provisioners we
cannot use wildcards, only individual files/directories can be copied to
the VMs. Not a big issue that can be circumvented in many ways.
- If a postprocess error occurs the VM is deleted and the whole process must
be repeated from scratch. A nice to have default behaviour would be to allow
a resume operation (i.e. OS is installed, some packages were successfully
installedbut scripts are missing; resuming would retry from the last stage).
- Vagrant postprocessor works copies the artifact to `/tmp` before building
the box. While in most cases this is not a problem, I got several *no space
left* errors when working on a system where `/tmp` is a ramdisk and overall
memory usage is high.



#Packer template

The template for **packer** is a JSON file containing several sections.

- Main section (`builders`) where the VM is defined. In this case a local ISO
and kickstart files are specified and the artifacts (that is, what is
produced by **packer**, is stored in `centos7-test` folder. Only a builder for
QEMU/KVM is set in this example but we could build VMs for Docker, EC2,
VirtualBox, VMWare, etc.

- `provisioners` section, where we can define how the VM will be provisioned
once the installation of the OS has ended. In other words, what additional
software needs to be installed and configured using either Puppet, Chef or
any other supported provisioner (see [https://www.packer.io/docs] for
more information).

- `post-processors` section where we can say what to do with the artifacts.


#Example:

Over all possible scenarios, a Centos7 vagrant box will be installed starting
from the minimal ISO.

- Additional software is provisioned by a shell script. Under the hood
autoprovisioning can also be defined straight into the kickstart file as
follows, but doing this may be redundant with the provisioner/s. In this
case an already existing kickstart file was used.
- By default users `vagrant` and `ssh` have password set to `vagrant` as
described in vagrant's
[base boxes specification](http://docs.vagrantup.com/v2/boxes/base.html).
Read 1st answer in [stackoverflow's discussion about vagrant security]
(http://stackoverflow.com/questions/14715678/vagrant-insecure-by-default)
for further details about well-known passwords.
- Artifact generated by the build stage (qcow2 hard disk file for KVM) isn't
deleted when the postprocessor is ended (see ***Cons*** above).
- For the kickstart file, optionally generate an encrypted password:

        :::bash
        python -c 'import crypt; print(crypt.crypt("vagrant"))'


##packer template

    :::json
    {
      "builders":
      [
        {
          "type": "qemu",
          "iso_url": "http://ftp.udl.es/pub/centos/7.0.1406/isos/x86_64/CentOS-7.0-1406-x86_64-Minimal.iso",
          "iso_checksum": "e3afe3f1121d69c40cc23f0bafa05e5d",
          "iso_checksum_type": "md5",
          "output_directory": "centos7-test",
          "ssh_wait_timeout": "30s",
          "shutdown_command": "shutdown -P now",
          "disk_size": 5000,
          "format": "qcow2",
          "headless": false,
          "accelerator": "kvm",
          "http_directory": ".",
          "http_port_min": 10082,
          "http_port_max": 10089,
          "ssh_host_port_min": 2222,
          "ssh_host_port_max": 2229,
          "ssh_username": "root",
          "ssh_password": "vagrant",
          "ssh_port": 22,
          "ssh_wait_timeout": "90m",
          "vm_name": "centos7",
          "net_device": "virtio-net",
          "disk_interface": "virtio",
          "boot_wait": "5s",
          "boot_command":
          [
            "<tab> text ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/centos7-ks.cfg<enter><wait>"
          ]
        }
      ],
    
      "provisioners":
      [
        {
          "type": "shell",
          "script": "script.sh",
          "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -E -S sh '{{ .Path }}'"
        }
      
      ],
    
      "post-processors":
      [
        {
          "type": "vagrant",
          "compression_level": 9,
          "keep_input_artifact": true
        }
      ]
    }


##provisioner shell script

    #!bash
    # Add EPEL repository
    yum install -y epel-release

    # Install git and clone remote repositories
    # Moved this to early stages to avoid nw outage due to reconfigurations
    yum install -y git
    git clone https://github.com/robbyrussell/oh-my-zsh.git /usr/share/oh-my-zsh
    git clone https://github.com/fernandezcuesta/dotfiles.git
    
    # Install missing packages
    yum install -y htop vim nano tmux setroubleshoot-server bash-completion python-psutil zsh
    yum groupinstall -y "Basic Web Server"
    
    # Enable serial line output
    echo "GRUB_TERMINAL=\"console serial\"" >> /etc/default/grub
    grubby --update-kernel=ALL --args="console=ttyS0"
    
    # Add user for vagrant
    useradd vagrant -G wheel
    
    # Put dotfiles in place
    mv dotfiles/nanorc/* /usr/share/nano/
    git clone https://github.com/gmarik/Vundle.vim.git dotfiles/.vim/bundle/Vundle.vim
    cp -R dotfiles/.vim /root
    cp -R dotfiles/.vim /home/vagrant
    mv dotfiles/*.tmux /usr/local/bin
    for file in dotfiles/.*; do [[ -f $file ]] && cp $file . && cp $file /home/vagrant; done
    chown -R vagrant:vagrant /home/vagrant
    rm -Rf dotfiles
    
    # Set zsh as default shell
    chsh -s `which zsh`
    chsh -s `which zsh` vagrant
    
    # Required by vagrant (http://docs.vagrantup.com/v2/boxes/base.html)
    sed -i 's/^\(Defaults[[:space:]]\+requiretty\)/#&\t# required by vagrant/' /etc/sudoers
    sed -i 's/!visiblepw/visiblepw\t# required by vagrant/' /etc/sudoers
    sed -i '/#\+\s*Same thing without a password/a vagrant ALL=(ALL) NOPASSWD: ALL' /etc/sudoers


##Kickstart file

    :::bash
    install
    cdrom
    lang en_US.UTF-8
    keyboard us
    network --bootproto=dhcp
    authconfig --enableshadow --passalgo=sha512
    rootpw --iscrypted $6$RTzeoVEVyTLdKaVM$DTxJ/lov4/JUNrTVtJR0IMdnaeg1DYhi9FsnJdeEae32ewZKqKt9L0aHa51HEgsJnL24WVF6DG1gPMCGwrRBU/
    firewall --enabled --service=ssh
    timezone GMT+1
    unsupported_hardware
    bootloader --location=mbr
    text
    skipx
     
    zerombr
    clearpart --all --initlabel
    part /boot --fstype=ext4 --size=256
    part pv.01 --grow --size=1
    volgroup VolGroup --pesize=4096 pv.01
    logvol / --fstype=xfs --name=lv_root --vgname=VolGroup --grow --size=1024
    logvol swap --name=lv_swap --vgname=VolGroup --size=2048
     
    auth --useshadow --passalgo=sha512
    firstboot --disabled
    reboot
     
    %packages --nobase
    @core
    openssh-clients
    sudo
    # unnecessary firmware
    -aic94xx-firmware
    -atmel-firmware
    -b43-openfwwf
    -bfa-firmware
    -ipw2100-firmware
    -ipw2200-firmware
    -ivtv-firmware
    -iwl100-firmware
    -iwl1000-firmware
    -iwl3945-firmware
    -iwl4965-firmware
    -iwl5000-firmware
    -iwl5150-firmware
    -iwl6000-firmware
    -iwl6000g2a-firmware
    -iwl6050-firmware
    -libertas-usb8388-firmware
    -ql2100-firmware
    -ql2200-firmware
    -ql23xx-firmware
    -ql2400-firmware
    -ql2500-firmware
    -rt61pci-firmware
    -rt73usb-firmware
    -xorg-x11-drv-ati-firmware
    -zd1211-firmware
    #
    -nfs
    -nfs-utils
    -iscsi-initiator-utils
    -bind
    -sendmail
    -fuse
    -xorg-x11-drivers
    -xorg-x11-server-Xorg
    %end
     
    %post
    /usr/bin/yum -y update
    %end


##Policy file allowing users in group wheel using libvirt services

By adding the following policykit rule we can avoid being prompted for
credentials every time we do a `vagrant up` or `vagrant ssh`:

    :::bash
    [/etc/polkit-1/rules.d/49-vagrant.rules]
    polkit.addRule(function(action, subject) {
        if (action.id == "org.libvirt.unix.manage" &&
            subject.isInGroup("wheel"))
            {
              return polkit.Result.YES;
            }
    });

