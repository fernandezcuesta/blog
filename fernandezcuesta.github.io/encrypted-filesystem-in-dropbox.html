<!DOCTYPE html>
<html lang=en><head><title>sys$notes &middot; Encrypted filesystem in&nbsp;Dropbox</title><meta http-equiv=Content-type content="text/html; charset=utf-8"><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel="shortcut icon" href=./theme/images/favicon.ico type=image/x-icon><meta name=author content="J.M. Fernández"><link href=http://fernandezcuesta.github.io/feeds/all.atom.xml type=application/atom+xml rel=alternate title="sys$notes Atom Feed"><link href=./theme/tipuesearch/tipuesearch.css rel=stylesheet><link rel=stylesheet href=./theme/css/bootstrap.min.css type=text/css><link rel=stylesheet href=./theme/css/calepin.css type=text/css><link rel=stylesheet href=./theme/css/pygments.css type=text/css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css><script src=./theme/js/jquery.min.js></script><script src=./theme/js/bootstrap.min.js></script><script src=./theme/js/respond.min.js></script><script type=text/javascript>
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type=text/javascript>
    try {
        var pageTracker = _gat._getTracker("UA-56464775-1");
    pageTracker._trackPageview();
    } catch(err) {}</script></head><body><nav class="navbar navbar-static-top" role=navigation><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=sr-only>Toggle navigation</span><span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="navbar-collapse collapse"><div id=header><div class="col-xs-5 col-md-6 col-lg-6 header_box"><ul><li class=headsubtitle>yet another personal blog</li><li class=headtitle><a href=.><img src=./theme/images/title.png alt=sys$notes></a></li></ul></div><div class="col-xs-6 col-md-5 col-lg-5 header_controls"><ul id=nav><li><a href=.>Home</a></li><li><a href=./archives.html>Archives</a></li><li><a href=https://about.me/fernandez.cuesta>About</a></li><li><a class=social href=https://plus.google.com/+JMFernándezC><i class="fa fa-google-plus-square fa-2x" title=google-plus></i></a><a class=social href=https://github.com/fernandezcuesta/><i class="fa fa-github-square fa-2x" title=github></i></a></li></ul><div class="row navbar-header navbar-right" id=searchbox><form action=search.html><input type=text name=q id=tipue_search_input autocomplete=off required></form></div></div></div></div></nav><div class=container><div id=content><div class=row><div class="col-xs-12 col-md-12 col-lg-12"></div></div><div class="row post"><div class="izquierda col-xs-2 col-md-2 col-lg-2"><div class=date><div class=dateday>Fri 27</div><div class=datemonth>Mar</div></div><div class=tags><ul><li><a href=./tag/security.html>security</a></li><li><a href=./tag/linux.html>linux</a></li><li><a href=./tag/internet.html>internet</a></li></ul></div></div><div class="derecha col-xs-10 col-md-10 col-lg-10"><h1 class=title><a href=javascript:javascript:history.go(-1) rel=bookmark title="Encrypted filesystem in Dropbox">Encrypted filesystem in&nbsp;Dropbox</a></h1><section class=post_content><p>The idea is to set up a container where we can put private/secret files. A way to achieve this is setting up <strong><span class=caps>LUKS</span></strong> on top of a fix-length file, i.e. <code>~/Dropbox/private.img</code>.</p><h2>Initialization:</h2><ul><li><p>Initialize a (for example) <span class=caps>100MB</span>&nbsp;file:</p><div class=highlight><pre><span class=nv>$ </span>dd <span class=k>if</span><span class=o>=</span>/dev/urandom <span class=nv>of</span><span class=o>=</span>/tmp/private.img <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span>100
</pre></div></li><li><p>Give format to the container while setting a&nbsp;passphrase:</p><div class=highlight><pre><span class=nv>$ </span>cryptsetup luksFormat /tmp/private.img
<span class=nv>$ </span>sudo cryptsetup open /tmp/private.img private
<span class=nv>$ </span>sudo mkfs.ext4 -L Private /dev/mapper/private
</pre></div></li><li><p>Mount and copy files to&nbsp;it</p><div class=highlight><pre><span class=nv>$ </span>mkdir /tmp/private
<span class=nv>$ </span>sudo mount /dev/mapper/private /tmp/private
<span class=nv>$ </span>sudo chown -R <span class=sb>`</span>whoami<span class=sb>`</span> /tmp/priv
<span class=nv>$ </span>cp ~/my_private_files/* /tmp/private
</pre></div></li><li><p>Dismount and move the container to its final&nbsp;location:</p><div class=highlight><pre><span class=nv>$ </span>sudo umount /tmp/private
<span class=nv>$ </span>sudo cryptsetup luksClose private
<span class=nv>$ </span>mv /tmp/private.img ~/Dropbox/private.img
</pre></div></li></ul><h2>Configuration:</h2><p>For this to be shown as a device, we can do the&nbsp;following:</p><h3>Option 1: using <code>/etc/rc.local</code></h3><div class=highlight><pre><table class=highlight_inline_table><tr><td class=linenos><div class=linenodiv><pre> 1</pre></div></td><td class=code><span class=c>#!/bin/bash</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 2</pre></div></td><td class=code><span class=nv>IMG_LOCATION</span><span class=o>=</span>/home/user/Dropbox/private.img
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 3</pre></div></td><td class=code><span class=k>case</span> <span class=nv>$1</span> in
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 4</pre></div></td><td class=code> start<span class=o>)</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 5</pre></div></td><td class=code> <span class=c># start script</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 6</pre></div></td><td class=code> losetup &#8212;find &#8212;show <span class=nv>$IMG_LOCATION</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 7</pre></div></td><td class=code> <span class=p>;;</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 8</pre></div></td><td class=code> stop<span class=o>)</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre> 9</pre></div></td><td class=code> <span class=c># stop script</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre>10</pre></div></td><td class=code> losetup -d <span class=sb>`</span>losetup <span class=p>|</span> grep -Po <span class=s2>&#8220;.+(?=(\s+\d){4}.*</span><span class=nv>$IMG_LOCATION</span><span class=s2>)&#8221;</span><span class=sb>`</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre>11</pre></div></td><td class=code> <span class=p>;;</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre>12</pre></div></td><td class=code><span class=k>esac</span>
</td></tr><tr><td class=linenos><div class=linenodiv><pre>13</pre></div></td><td class=code><span class=nb>exit</span>
</td></tr></table></pre></div><p>To start this on every boot&nbsp;do:</p><div class=highlight><pre><span class=nv>$ </span>sudo chmod +x /etc/rc.local
</pre></div><p>And ensure the unit file for <code>rc.local</code> compatibility (<code>/etc/systemd/system/rc-local.service</code>) is enabled and&nbsp;contains:</p><div class=highlight><pre><span class=o>[</span>Unit<span class=o>]</span>
<span class=nv>Description</span><span class=o>=</span>/etc/rc.local Compatibility
<span class=nv>ConditionPathExists</span><span class=o>=</span>/etc/rc.local

<span class=o>[</span>Service<span class=o>]</span>
<span class=nv>Type</span><span class=o>=</span>forking
<span class=nv>ExecStart</span><span class=o>=</span>/etc/rc.local start
<span class=nv>ExecStop</span><span class=o>=</span>/etc/rc.local stop
<span class=nv>TimeoutSec</span><span class=o>=</span>0
<span class=nv>StandardOutput</span><span class=o>=</span>tty
<span class=nv>RemainAfterExit</span><span class=o>=</span>yes
<span class=nv>SysVStartPriority</span><span class=o>=</span>99

<span class=o>[</span>Install<span class=o>]</span>
<span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</pre></div><h3>Option 2: systemd&nbsp;unit</h3><p>Create a systemd user unit file as follows under <code>/etc/systemd/system</code>, for example <code>/etc/systemd/system/mountloop.service</code>:</p><div class=highlight><pre><span class=o>[</span>Unit<span class=o>]</span>
<span class=nv>Description</span><span class=o>=</span>Mount loop device
<span class=nv>DefaultDependencies</span><span class=o>=</span>no
<span class=nv>Conflicts</span><span class=o>=</span>umount.target
<span class=nv>Before</span><span class=o>=</span><span class=nb>local</span>-fs.target umount.target


<span class=o>[</span>Service<span class=o>]</span>
<span class=nv>Type</span><span class=o>=</span>forking
<span class=nv>Environment</span><span class=o>=</span><span class=s2>&quot;IMG_LOCATION=/home/user/Dropbox/private.img&quot;</span>
<span class=nv>ExecStart</span><span class=o>=</span>/usr/sbin/losetup --find --show <span class=si>${</span><span class=nv>IMG_LOCATION</span><span class=si>}</span>
<span class=nv>ExecStop</span><span class=o>=</span>/bin/bash -c <span class=s2>&quot;/usr/sbin/losetup -d `losetup | grep -Po \&quot;.+(?=(\s+\d){4}.*</span><span class=si>${</span><span class=nv>IMG_LOCATION</span><span class=si>}</span><span class=s2>)\&quot;`&quot;</span>
<span class=nv>TimeoutSec</span><span class=o>=</span>0
<span class=nv>RemainAfterExit</span><span class=o>=</span>yes

<span class=o>[</span>Install<span class=o>]</span>
<span class=nv>WantedBy</span><span class=o>=</span>default.target
</pre></div><p>Then enable this unit&nbsp;file:</p><div class=highlight><pre><span class=nv>$ </span>sudo systemctl daemon-reload
<span class=nv>$ </span>sudo systemctl <span class=nb>enable </span>mountloop
<span class=nv>$ </span>sudo systemctl start mountloop
</pre></div></section><div class=clear></div><div class=row><div class="col-xs-3 col-md-2 col-lg-2 archives izquierda"></div><div class="col-xs-8 col-md-9 col-lg-9 post archives"><a class=more href=javascript:javascript:history.go(-1)>&#8672;&nbsp;BACK&nbsp;&#8672;</a></div></div></div></div><div class=comments><div class="row post"><div class="col-xs-10 col-md-10 col-lg-10 comments_content comments_header"><h2>Leave your comments:</h2></div><div class="col-xs-2 col-md-2 col-lg-2 comments_corner"></div></div><div class="row flex-row"><div class="col-xs-10 col-md-10 col-lg-10 comments_content"><div id=disqus_thread><script type=text/javascript>
                       var disqus_identifier = "encrypted-filesystem-in-dropbox.html";
                       (function() {
                       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                       dsq.src = 'http://vt100.disqus.com/embed.js';
                       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                      })();
                    </script></div></div><div class=comments_side></div></div></div><div class=spacer></div><div class=clear></div></div><div class=row id=footer><div class=license_img><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons Attribution 4.0 International License" style=border-width:0 src=https://i.creativecommons.org/l/by/4.0/88x31.png></a></div><div class=license><div><span xmlns:dct=http://purl.org/dc/terms/ property=dct:title><strong>sys$notes</strong></span> is licensed under a <a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a></div><div><p>Proudly powered by <a href=http://getpelican.com>Pelican</a>&nbsp;&middot;&nbsp;Calepin theme</p></div></div></div><div class=clear></div></div></body></html>